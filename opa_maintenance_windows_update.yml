---
- name: Preview OPA maintenance window update (timezone-aware)
  hosts: opa.containersarelinux.net
  gather_facts: false
  vars:
    timezone: Europe/Stockholm
    rego_file_path: /home/jboivie/aap25/rego_policies/runtime/maintenance_window.rego
  tasks:
    - name: Get current time in Swedish local time
      set_fact:
        now_swedish: "{{ lookup('pipe', 'date +%Y-%m-%dT%H:%M:%S') | to_datetime('%Y-%m-%dT%H:%M:%S') | to_timezone(timezone) }}"

    - name: Calculate UTC maintenance window start and end (rounded to hour)
      set_fact:
        start_hour_utc: "{{ (now_swedish.replace(minute=0, second=0) - timedelta(hours=1)).astimezone('UTC').hour }}"
        end_hour_utc: "{{ (now_swedish.replace(minute=0, second=0) + timedelta(hours=1)).astimezone('UTC').hour }}"

    - name: Show calculated UTC maintenance window
      debug:
        msg: |
          maintenance_start_hour := {{ start_hour_utc }}
          maintenance_end_hour := {{ end_hour_utc }}

    # - name: Replace maintenance_start_hour in rego file
    #   replace:
    #     path: "{{ rego_file_path }}"
    #     regexp: 'maintenance_start_hour\s*:=\s*\d+'
    #     replace: "maintenance_start_hour := {{ start_hour_utc }}"

    # - name: Replace maintenance_end_hour in rego file
    #   replace:
    #     path: "{{ rego_file_path }}"
    #     regexp: 'maintenance_end_hour\s*:=\s*\d+'
    #     replace: "maintenance_end_hour := {{ end_hour_utc }}"